# Queries to collect data from NYU Datathon
# Each inividual query is separated by the /* */ symbol
# The query below is designed to pull multiple tables, with the admission data being the "center" table in a star relationshape schema.
# All data is subsequently joined in R and Python

/*QUERY FOR ADMISSION DATA*/
# Where clause demonstrate how data is searched for
# DRG code 175 and 176 are used as an inclusion criteria, which represents patients with PE
# DRG codes 134.1, 134.2, 134.3 and 134.4 also represents PE. However, these are the APR-DRG codes, and these codes sometimes pulled patients with
# "COMPLICATED PEPTIC ULCER" or "GASTROINTESTINAL HEMORRHAGE WITHOUT COMPLICATIONS, COMORBIDITIES". These patients were therefore excluded
# ICD9 code 415.* is for pulmonary embolism
# Additionally, a right join with the Note Events table was utilized with a where clause looking for CT scan notes.
SELECT DISTINCT PatDim.SUBJECT_ID, Admissions.HADM_ID, PatDim.GENDER, PatDim.DOB,
  PatDim.DOD, PatDim.DOD_HOSP, PatDim.DOD_SSN, PatDim.EXPIRE_FLAG,
  Admissions.DIAGNOSIS, Admissions.LANGUAGE, Admissions.ETHNICITY, Admissions.MARITAL_STATUS, Admissions.RELIGION, Admissions.INSURANCE, 
  Admissions.ADMITTIME, Admissions.DISCHTIME, Admissions.DEATHTIME,
  Admissions.ADMISSION_LOCATION, Admissions.DISCHARGE_LOCATION
  FROM `mimiciii_clinical.admissions` AS Admissions

left join `mimiciii_clinical.diagnoses_icd` AS Dx on
Admissions.HADM_ID = Dx.HADM_ID

left join `mimiciii_clinical.drgcodes` AS DrgDim on
Admissions.HADM_ID = DrgDim.HADM_ID

left join `mimiciii_clinical.patients` AS PatDim on
Admissions.SUBJECT_ID = PatDim.SUBJECT_ID

right join (select DISTINCT * from `mimiciii_derived.noteevents_metadata` 

where DESCRIPTION IN
    ('CHEST CTA WITH CONTRAST',
    'CT CHEST AND ABDOMEN W/O CONTRAST',
    'CT CHEST W&W/O C',
    'CT CHEST W/CONT+RECONSTRUCTION',
    'CT CHEST W/CONTRAST',
    'CT CHEST W/CONTRAST W/ONC TABLE',
    'CT CHEST W/O CONTRAST',
    'CT CHEST W/O CONTRAST W/ONC TABLES',
    'CT STEREOTAXIS CHEST W/ CONTRAST',
    'CTA CHEST W&W/O C &RECONS',
    'CTA CHEST W&W/O C&RECONS, NON-CORONARY',
    'NLSA CT CHEST WITHOUT CONTRAST',
    'P CTA CHEST W&W/O C&RECONS, NON-CORONARY PORT')
    ) AS CT ON
  Admissions.HADM_ID = CT.HADM_ID

left join `mimiciii_clinical.icustays` ICUStayDim on
Admissions.HADM_ID = ICUStayDim.HADM_ID

left join (select ECGNote.SUBJECT_ID, ECGNote.HADM_ID, ECGNote.CHARTDATE, ECGNote.CATEGORY,
  ECGNote.DESCRIPTION, ECGNote.CGID, ECGNote.ISERROR, ECGNote.TEXT
  from `mimiciii_notes.noteevents` AS ECGNote

  where CATEGORY = 'ECG') AS ECG on
  Admissions.HADM_ID = ECG.HADM_ID
  
where (Dx.ICD9_CODE LIKE "415%"
    OR DrgDim.DRG_CODE in (175, 176, 1341, 1342, 1343, 1344)
    OR (DrgDim.DRG_CODE in (175, 176)
      AND DrgDim.DESCRIPTION != 'COMPLICATED PEPTIC ULCER'
      AND DrgDim.DESCRIPTION != 'GASTROINTESTINAL HEMORRHAGE WITHOUT COMPLICATIONS, COMORBIDITIES'))
  AND ADMISSION_LOCATION = 'EMERGENCY ROOM ADMIT';

/*QUERY FOR CT NOTES*/
# Collecting actual CT notes. This is similar to the previous query, therefore reducing down the number of patients. However, the
# select clause is only looking for the patient's note data.
# This data is primarily being used for the "DESCRIPTION" column, which informs us whether the patient received a CT chest with contrast
SELECT DISTINCT PatDim.SUBJECT_ID, Admissions.HADM_ID, CT.CHARTDATE, CT.CHARTTIME, CT.STORETIME, CT.CATEGORY, CT.DESCRIPTION, CT.CGID, CT.ISERROR, CT.TEXT
  FROM `mimiciii_clinical.admissions` AS Admissions

left join `mimiciii_clinical.diagnoses_icd` AS Dx on
Admissions.HADM_ID = Dx.HADM_ID

left join `mimiciii_clinical.drgcodes` AS DrgDim on
Admissions.HADM_ID = DrgDim.HADM_ID

left join `mimiciii_clinical.patients` AS PatDim on
Admissions.SUBJECT_ID = PatDim.SUBJECT_ID

right join (select DISTINCT * from `mimiciii_notes.noteevents` 

where DESCRIPTION IN
    ('CHEST CTA WITH CONTRAST',
    'CT CHEST AND ABDOMEN W/O CONTRAST',
    'CT CHEST W&W/O C',
    'CT CHEST W/CONT+RECONSTRUCTION',
    'CT CHEST W/CONTRAST',
    'CT CHEST W/CONTRAST W/ONC TABLE',
    'CT CHEST W/O CONTRAST',
    'CT CHEST W/O CONTRAST W/ONC TABLES',
    'CT STEREOTAXIS CHEST W/ CONTRAST',
    'CTA CHEST W&W/O C &RECONS',
    'CTA CHEST W&W/O C&RECONS, NON-CORONARY',
    'NLSA CT CHEST WITHOUT CONTRAST',
    'P CTA CHEST W&W/O C&RECONS, NON-CORONARY PORT')
    ) AS CT ON
  Admissions.HADM_ID = CT.HADM_ID

left join `mimiciii_clinical.icustays` ICUStayDim on
Admissions.HADM_ID = ICUStayDim.HADM_ID
  
where (Dx.ICD9_CODE LIKE "415%"
    OR DrgDim.DRG_CODE in (175, 176, 1341, 1342, 1343, 1344)
      AND DrgDim.DESCRIPTION != 'COMPLICATED PEPTIC ULCER'
      AND DrgDim.DESCRIPTION != 'GASTROINTESTINAL HEMORRHAGE WITHOUT COMPLICATIONS, COMORBIDITIES'))
  AND ADMISSION_LOCATION = 'EMERGENCY ROOM ADMIT';

/*ICU Stays*/
SELECT DISTINCT PatDim.SUBJECT_ID, Admissions.HADM_ID,
  ICUStayDim.ICUSTAY_ID, ICUStayDim.DBSOURCE, ICUStayDim.FIRST_CAREUNIT,
  ICUStayDim.LAST_CAREUNIT, ICUStayDim.INTIME, ICUStayDim.OUTTIME,
  ICUStayDim.LOS
  FROM `mimiciii_clinical.admissions` AS Admissions

left join `mimiciii_clinical.diagnoses_icd` AS Dx on
Admissions.HADM_ID = Dx.HADM_ID

left join `mimiciii_clinical.drgcodes` AS DrgDim on
Admissions.HADM_ID = DrgDim.HADM_ID

left join `mimiciii_clinical.patients` AS PatDim on
Admissions.SUBJECT_ID = PatDim.SUBJECT_ID

right join (select DISTINCT * from `mimiciii_notes.noteevents` 

where DESCRIPTION IN
    ('CHEST CTA WITH CONTRAST',
    'CT CHEST AND ABDOMEN W/O CONTRAST',
    'CT CHEST W&W/O C',
    'CT CHEST W/CONT+RECONSTRUCTION',
    'CT CHEST W/CONTRAST',
    'CT CHEST W/CONTRAST W/ONC TABLE',
    'CT CHEST W/O CONTRAST',
    'CT CHEST W/O CONTRAST W/ONC TABLES',
    'CT STEREOTAXIS CHEST W/ CONTRAST',
    'CTA CHEST W&W/O C &RECONS',
    'CTA CHEST W&W/O C&RECONS, NON-CORONARY',
    'NLSA CT CHEST WITHOUT CONTRAST',
    'P CTA CHEST W&W/O C&RECONS, NON-CORONARY PORT')
    ) AS CT ON
  Admissions.HADM_ID = CT.HADM_ID
  
left join `mimiciii_clinical.icustays` ICUStayDim on
Admissions.HADM_ID = ICUStayDim.HADM_ID
  
where (Dx.ICD9_CODE LIKE "415%"
    OR DrgDim.DRG_CODE in (175, 176, 1341, 1342, 1343, 1344)
    OR (DrgDim.DRG_CODE in (175, 176)
      AND DrgDim.DESCRIPTION != 'COMPLICATED PEPTIC ULCER'
      AND DrgDim.DESCRIPTION != 'GASTROINTESTINAL HEMORRHAGE WITHOUT COMPLICATIONS, COMORBIDITIES'))
  AND ADMISSION_LOCATION = 'EMERGENCY ROOM ADMIT';

/*QUERY FOR ECG Note*/
# Similar as above, this is querying for patients with ECG notes. This was originally going to be used to find patients with Atrial Fibrillation/Flutter based
# on the text from the note (String find). Instead, Chart Event was used for heart rhythms.
SELECT DISTINCT PatDim.SUBJECT_ID, Admissions.HADM_ID, ECGNote.CHARTDATE, ECGNote.CATEGORY,
  ECGNote.DESCRIPTION, ECGNote.CGID, ECGNote.ISERROR, ECGNote.TEXT
  FROM `mimiciii_clinical.admissions` AS Admissions

left join `mimiciii_clinical.diagnoses_icd` AS Dx on
Admissions.HADM_ID = Dx.HADM_ID

left join `mimiciii_clinical.drgcodes` AS DrgDim on
Admissions.HADM_ID = DrgDim.HADM_ID

left join `mimiciii_clinical.patients` AS PatDim on
Admissions.SUBJECT_ID = PatDim.SUBJECT_ID

right join (select DISTINCT * from `mimiciii_notes.noteevents` 

where DESCRIPTION IN
    ('CHEST CTA WITH CONTRAST',
    'CT CHEST AND ABDOMEN W/O CONTRAST',
    'CT CHEST W&W/O C',
    'CT CHEST W/CONT+RECONSTRUCTION',
    'CT CHEST W/CONTRAST',
    'CT CHEST W/CONTRAST W/ONC TABLE',
    'CT CHEST W/O CONTRAST',
    'CT CHEST W/O CONTRAST W/ONC TABLES',
    'CT STEREOTAXIS CHEST W/ CONTRAST',
    'CTA CHEST W&W/O C &RECONS',
    'CTA CHEST W&W/O C&RECONS, NON-CORONARY',
    'NLSA CT CHEST WITHOUT CONTRAST',
    'P CTA CHEST W&W/O C&RECONS, NON-CORONARY PORT')
    ) AS CT ON
  Admissions.HADM_ID = CT.HADM_ID

left join `mimiciii_clinical.icustays` ICUStayDim on
Admissions.HADM_ID = ICUStayDim.HADM_ID

left join (select ECGNote.SUBJECT_ID, ECGNote.HADM_ID, ECGNote.CHARTDATE, ECGNote.CATEGORY,
  ECGNote.DESCRIPTION, ECGNote.CGID, ECGNote.ISERROR, ECGNote.TEXT
  from `mimiciii_notes.noteevents` AS ECGNote

  where CATEGORY = 'ECG') AS ECGNote on
  Admissions.HADM_ID = ECGNote.HADM_ID
  
where (Dx.ICD9_CODE LIKE "415%"
    OR DrgDim.DRG_CODE in (175, 176, 1341, 1342, 1343, 1344)
    OR (DrgDim.DRG_CODE in (175, 176)
      AND DrgDim.DESCRIPTION != 'COMPLICATED PEPTIC ULCER'
      AND DrgDim.DESCRIPTION != 'GASTROINTESTINAL HEMORRHAGE WITHOUT COMPLICATIONS, COMORBIDITIES'))
  AND ADMISSION_LOCATION = 'EMERGENCY ROOM ADMIT';

/*Chart Events Rhythms*/
# Finding heart rhythms based on charting events. Again, finding the patients is the same as the admissions table.
# This table was used for the heart rhythm instead of the EKGs because this is structured data.
SELECT DISTINCT Admissions.HADM_ID, ChartEvents.ICUSTAY_ID, ChartEvents.LABEL,
  ChartEvents.CHARTTIME, ChartEvents.STORETIME, ChartEvents.CGID, ChartEvents.VALUE, ChartEvents.WARNING,
  ChartEvents.ERROR
  FROM `mimiciii_clinical.admissions` AS Admissions

left join `mimiciii_clinical.diagnoses_icd` AS Dx on
Admissions.HADM_ID = Dx.HADM_ID

left join `mimiciii_clinical.drgcodes` AS DrgDim on
Admissions.HADM_ID = DrgDim.HADM_ID

left join `mimiciii_clinical.patients` AS PatDim on
Admissions.SUBJECT_ID = PatDim.SUBJECT_ID

right join (select DISTINCT * from `mimiciii_derived.noteevents_metadata` 

where DESCRIPTION IN
    ('CHEST CTA WITH CONTRAST',
    'CT CHEST AND ABDOMEN W/O CONTRAST',
    'CT CHEST W&W/O C',
    'CT CHEST W/CONT+RECONSTRUCTION',
    'CT CHEST W/CONTRAST',
    'CT CHEST W/CONTRAST W/ONC TABLE',
    'CT CHEST W/O CONTRAST',
    'CT CHEST W/O CONTRAST W/ONC TABLES',
    'CT STEREOTAXIS CHEST W/ CONTRAST',
    'CTA CHEST W&W/O C &RECONS',
    'CTA CHEST W&W/O C&RECONS, NON-CORONARY',
    'NLSA CT CHEST WITHOUT CONTRAST',
    'P CTA CHEST W&W/O C&RECONS, NON-CORONARY PORT')
    ) AS CT ON
  Admissions.HADM_ID = CT.HADM_ID

left join `mimiciii_clinical.icustays` ICUStayDim on
Admissions.HADM_ID = ICUStayDim.HADM_ID

left join (select ChartEvents.*, Items.LABEL
  from `mimiciii_clinical.chartevents` AS ChartEvents
  
  left join `mimiciii_clinical.d_items` Items on
  ChartEvents.ITEMID = Items.ITEMID
  
  where Items.LABEL IN
    ('Heart Rhythm',
    'Cardiac Rhythm',
    'EKG',
    'ECG')) AS ChartEvents ON
  Admissions.HADM_ID = ChartEvents.HADM_ID

where (Dx.ICD9_CODE LIKE "415%"
    OR DrgDim.DRG_CODE in (175, 176, 1341, 1342, 1343, 1344)
    OR (DrgDim.DRG_CODE in (175, 176)
      AND DrgDim.DESCRIPTION != 'COMPLICATED PEPTIC ULCER'
      AND DrgDim.DESCRIPTION != 'GASTROINTESTINAL HEMORRHAGE WITHOUT COMPLICATIONS, COMORBIDITIES'))
  AND ADMISSION_LOCATION = 'EMERGENCY ROOM ADMIT';

/*Querying Drugs*/
# Due to time constratints, patients were selected based on the unique HADM_ID from the admissions table.
# Drugs were selected for based on text string (e.g. -alol or -olol for beta blockers). This table was not used due to time constraints
select DISTINCT MedDim.HADM_ID, MedDim.ICUSTAY_ID,
  MedDim.STARTDATE, MedDim.ENDDATE,  
  MedDim.DRUG, MedDim.DRUG_NAME_POE, MedDim.DRUG_NAME_GENERIC from `mimiciii_clinical.prescriptions` MedDim

where
  # BETA BLOCKERS
  (((DRUG LIKE '%olol%' OR DRUG_NAME_POE LIKE '%olol%' OR DRUG_NAME_GENERIC LIKE '%olol%'
  OR DRUG LIKE '%OLOL%' OR DRUG_NAME_POE LIKE '%OLOL%' OR DRUG_NAME_GENERIC LIKE '%OLOL%'
  OR DRUG LIKE '%alol%' OR DRUG_NAME_POE LIKE '%alol%' OR DRUG_NAME_GENERIC LIKE '%alol%'
  OR DRUG LIKE '%ALOL%' OR DRUG_NAME_POE LIKE '%ALOL%' OR DRUG_NAME_GENERIC LIKE '%ALOL%')
  AND (DRUG NOT LIKE '%Timolol%' AND DRUG_NAME_POE NOT LIKE '%Timolol%' AND DRUG_NAME_GENERIC NOT LIKE '%Timolol%'
  AND DRUG NOT LIKE '%timolol%' AND DRUG_NAME_POE NOT LIKE '%timolol%' AND DRUG_NAME_GENERIC NOT LIKE '%timolol%'))
  # DIGOXIN
  OR (DRUG LIKE '%Digoxin%' OR DRUG_NAME_POE LIKE '%Digoxin%' OR DRUG_NAME_GENERIC LIKE '%Digoxin%'
  AND (DRUG != 'Indigotindisulfonate Sodium' AND DRUG_NAME_POE != 'Indigotindisulfonate Sodium' AND DRUG_NAME_GENERIC != 'Indigotindisulfonate Sodium'))
  # AMIORODARONE
  OR DRUG LIKE '%Amio%'
  # Diltiazem
  OR DRUG LIKE '%Dilt%' OR DRUG_NAME_POE LIKE '%Dilt%' OR DRUG_NAME_GENERIC LIKE '%Dilt%'
  OR DRUG LIKE '%DILT%' OR DRUG_NAME_POE LIKE '%DILT%' OR DRUG_NAME_GENERIC LIKE '%DILT%'
  OR DRUG LIKE '%dilt%' OR DRUG_NAME_POE LIKE '%dilt%' OR DRUG_NAME_GENERIC LIKE '%dilt%'
  # Verampamil
  OR (DRUG LIKE '%Vera%' OR DRUG_NAME_POE LIKE '%Vera%' OR DRUG_NAME_GENERIC LIKE '%Vera%'
  AND (DRUG != 'Provera' AND DRUG_NAME_POE != 'Provera' AND DRUG_NAME_GENERIC != 'Provera')))
  AND MedDim.HADM_ID in
  (139788,
  182135,
  172454,
  165934,
  144159,
  110275,
  100826,
  164098,
  129744,
  182573,
  199898,
  154639,
  142149,
  114241,
  107530,
  130079,
  128160,
  198911,
  195826,
  152188,
  167021,
  138421,
  158183,
  196065,
  106481,
  103175,
  167558,
  161020,
  185409,
  109340,
  188192,
  181683,
  142100,
  178274,
  113350,
  138803,
  119596,
  127242,
  102942,
  110568,
  134311,
  175238,
  199207,
  125277,
  178211,
  151145,
  131893,
  179968,
  109361,
  100525,
  124391,
  125077,
  151731,
  196982,
  197611,
  123815,
  174899,
  191645,
  169308,
  172466,
  125303,
  169182,
  169525,
  144752,
  124627,
  172672,
  163318,
  157722,
  103931,
  173330,
  182280,
  131239,
  144709,
  125831,
  142254,
  181593,
  187907,
  143994,
  183007,
  122694,
  118736,
  194201,
  113272,
  168854,
  190004,
  115843,
  100187,
  109789,
  139698,
  146274,
  167200,
  142220,
  180931,
  196923,
  148135,
  186563,
  135816,
  154406,
  122008,
  128939,
  146001,
  114875,
  176465,
  189800,
  133123,
  107449,
  115789,
  168926,
  123997,
  198939,
  171444,
  102486,
  164491,
  164045,
  127372,
  124978,
  122833,
  153465,
  140567,
  129591,
  109177,
  197164,
  136113,
  125994,
  135402,
  124090,
  172231,
  130339,
  110565,
  187245,
  191928,
  176069,
  149772,
  153168,
  178987,
  113352,
  195738,
  131822,
  134829,
  176952,
  100575,
  118985,
  166576,
  175356,
  167545,
  100751,
  114608,
  185178,
  174576,
  118633,
  142398,
  101266,
  120230,
  171678,
  100584,
  190685,
  115245,
  111685,
  185837,
  138477,
  154613,
  186572,
  158616,
  181085,
  130727,
  177514,
  136084,
  194728,
  118521,
  193169,
  109760,
  108685,
  147705,
  120442,
  106011,
  193351,
  100030,
  135931,
  116814,
  192838,
  128551,
  121230,
  141664,
  148647,
  174449,
  110118,
  189434,
  197327,
  148971,
  166975,
  187036,
  190669,
  133462,
  130729,
  145785,
  149505,
  175438,
  185562,
  194657,
  188684,
  137650,
  163354,
  190479,
  122767,
  192255,
  181819,
  159989,
  114600,
  129723,
  152022,
  183460,
  199082,
  137236,
  130976,
  153323,
  140695,
  172970,
  143957,
  185663,
  176097,
  128820,
  137954,
  104178,
  159775,
  196214,
  145248,
  114966,
  119486,
  152544,
  171645,
  103536,
  165555,
  102497,
  138107,
  142459,
  112708,
  150709,
  185880,
  177936,
  170682,
  123562,
  155766,
  179295,
  145132,
  133292,
  104849,
  105316,
  106345,
  106598,
  199909,
  170174,
  126687,
  156055,
  135487,
  147116,
  130430,
  162870,
  119437,
  153476,
  177633,
  140501,
  119703,
  147424,
  193135,
  193966,
  134007,
  125835,
  120501,
  173941,
  171996,
  175366,
  180029,
  143170,
  109946,
  155003,
  197965,
  198299,
  157955,
  194762,
  147692,
  142391,
  131236,
  138680,
  130076,
  163302,
  134599,
  189465,
  168087,
  186629,
  108482,
  179237,
  189583,
  138790,
  158130,
  188536,
  128091,
  176777,
  141048,
  157336,
  123375,
  192572,
  166585,
  158050,
  170681,
  128051,
  124867,
  152365,
  141081,
  174684,
  141268,
  196212,
  160465,
  117365,
  182868,
  187951,
  187617,
  186470,
  153119,
  153102,
  131885,
  141787,
  113509,
  151364,
  106296,
  102735,
  115961,
  171451,
  124038,
  140887,
  137032,
  193045,
  188843,
  187032,
  133463,
  119804,
  163976,
  129648,
  118574,
  103629,
  130358,
  122659,
  181599,
  111057,
  194869,
  131143,
  168118,
  153468,
  133404,
  104850,
  157398,
  194125,
  146115,
  103997,
  162478,
  197959,
  128573,
  128912,
  131639,
  179681,
  170978,
  132585,
  168225)

/*Vassopressor Time*/
# Due to time constratints, patients were selected based on the unique HADM_ID from the admissions table.
# Here we identified patients that used a vasopressor. Vasopressors were identified based on ITEMID, which was found on the dervied table github.
# The UNION ALL was utilized as there was a CV and MV table (two different EHRs).
select InputEvents_CV.HADM_ID, InputEvents_CV.ICUSTAY_ID, InputEvents_CV.CHARTTIME AS APPROXIMATETIME, MedDim.LABEL
  from `mimiciii_clinical.inputevents_cv` InputEvents_CV

left join `mimiciii_clinical.d_items` MedDim on
InputEvents_CV.ITEMID = MedDim.ITEMID

where MedDim.ITEMID in (30047,30120,30044,30119,30309,30127,30128,30051,30043,30307,30042,30306,30125,42273,42802)
  AND HADM_ID in
  (139788,
  182135,
  172454,
  165934,
  144159,
  110275,
  100826,
  164098,
  129744,
  182573,
  199898,
  154639,
  142149,
  114241,
  107530,
  130079,
  128160,
  198911,
  195826,
  152188,
  167021,
  138421,
  158183,
  196065,
  106481,
  103175,
  167558,
  161020,
  185409,
  109340,
  188192,
  181683,
  142100,
  178274,
  113350,
  138803,
  119596,
  127242,
  102942,
  110568,
  134311,
  175238,
  199207,
  125277,
  178211,
  151145,
  131893,
  179968,
  109361,
  100525,
  124391,
  125077,
  151731,
  196982,
  197611,
  123815,
  174899,
  191645,
  169308,
  172466,
  125303,
  169182,
  169525,
  144752,
  124627,
  172672,
  163318,
  157722,
  103931,
  173330,
  182280,
  131239,
  144709,
  125831,
  142254,
  181593,
  187907,
  143994,
  183007,
  122694,
  118736,
  194201,
  113272,
  168854,
  190004,
  115843,
  100187,
  109789,
  139698,
  146274,
  167200,
  142220,
  180931,
  196923,
  148135,
  186563,
  135816,
  154406,
  122008,
  128939,
  146001,
  114875,
  176465,
  189800,
  133123,
  107449,
  115789,
  168926,
  123997,
  198939,
  171444,
  102486,
  164491,
  164045,
  127372,
  124978,
  122833,
  153465,
  140567,
  129591,
  109177,
  197164,
  136113,
  125994,
  135402,
  124090,
  172231,
  130339,
  110565,
  187245,
  191928,
  176069,
  149772,
  153168,
  178987,
  113352,
  195738,
  131822,
  134829,
  176952,
  100575,
  118985,
  166576,
  175356,
  167545,
  100751,
  114608,
  185178,
  174576,
  118633,
  142398,
  101266,
  120230,
  171678,
  100584,
  190685,
  115245,
  111685,
  185837,
  138477,
  154613,
  186572,
  158616,
  181085,
  130727,
  177514,
  136084,
  194728,
  118521,
  193169,
  109760,
  108685,
  147705,
  120442,
  106011,
  193351,
  100030,
  135931,
  116814,
  192838,
  128551,
  121230,
  141664,
  148647,
  174449,
  110118,
  189434,
  197327,
  148971,
  166975,
  187036,
  190669,
  133462,
  130729,
  145785,
  149505,
  175438,
  185562,
  194657,
  188684,
  137650,
  163354,
  190479,
  122767,
  192255,
  181819,
  159989,
  114600,
  129723,
  152022,
  183460,
  199082,
  137236,
  130976,
  153323,
  140695,
  172970,
  143957,
  185663,
  176097,
  128820,
  137954,
  104178,
  159775,
  196214,
  145248,
  114966,
  119486,
  152544,
  171645,
  103536,
  165555,
  102497,
  138107,
  142459,
  112708,
  150709,
  185880,
  177936,
  170682,
  123562,
  155766,
  179295,
  145132,
  133292,
  104849,
  105316,
  106345,
  106598,
  199909,
  170174,
  126687,
  156055,
  135487,
  147116,
  130430,
  162870,
  119437,
  153476,
  177633,
  140501,
  119703,
  147424,
  193135,
  193966,
  134007,
  125835,
  120501,
  173941,
  171996,
  175366,
  180029,
  143170,
  109946,
  155003,
  197965,
  198299,
  157955,
  194762,
  147692,
  142391,
  131236,
  138680,
  130076,
  163302,
  134599,
  189465,
  168087,
  186629,
  108482,
  179237,
  189583,
  138790,
  158130,
  188536,
  128091,
  176777,
  141048,
  157336,
  123375,
  192572,
  166585,
  158050,
  170681,
  128051,
  124867,
  152365,
  141081,
  174684,
  141268,
  196212,
  160465,
  117365,
  182868,
  187951,
  187617,
  186470,
  153119,
  153102,
  131885,
  141787,
  113509,
  151364,
  106296,
  102735,
  115961,
  171451,
  124038,
  140887,
  137032,
  193045,
  188843,
  187032,
  133463,
  119804,
  163976,
  129648,
  118574,
  103629,
  130358,
  122659,
  181599,
  111057,
  194869,
  131143,
  168118,
  153468,
  133404,
  104850,
  157398,
  194125,
  146115,
  103997,
  162478,
  197959,
  128573,
  128912,
  131639,
  179681,
  170978,
  132585,
  168225)

UNION ALL

select InputEvents_MV.HADM_ID, InputEvents_MV.ICUSTAY_ID, InputEvents_MV.STARTTIME AS APPROXIMATETIME, MedDim.LABEL
  from `mimiciii_clinical.inputevents_mv` InputEvents_MV

left join `mimiciii_clinical.d_items` MedDim on
InputEvents_MV.ITEMID = MedDim.ITEMID

where MedDim.ITEMID in (30047,30120,30044,30119,30309,30127,30128,30051,30043,30307,30042,30306,30125,42273,42802)
  AND HADM_ID in
  (139788,
  182135,
  172454,
  165934,
  144159,
  110275,
  100826,
  164098,
  129744,
  182573,
  199898,
  154639,
  142149,
  114241,
  107530,
  130079,
  128160,
  198911,
  195826,
  152188,
  167021,
  138421,
  158183,
  196065,
  106481,
  103175,
  167558,
  161020,
  185409,
  109340,
  188192,
  181683,
  142100,
  178274,
  113350,
  138803,
  119596,
  127242,
  102942,
  110568,
  134311,
  175238,
  199207,
  125277,
  178211,
  151145,
  131893,
  179968,
  109361,
  100525,
  124391,
  125077,
  151731,
  196982,
  197611,
  123815,
  174899,
  191645,
  169308,
  172466,
  125303,
  169182,
  169525,
  144752,
  124627,
  172672,
  163318,
  157722,
  103931,
  173330,
  182280,
  131239,
  144709,
  125831,
  142254,
  181593,
  187907,
  143994,
  183007,
  122694,
  118736,
  194201,
  113272,
  168854,
  190004,
  115843,
  100187,
  109789,
  139698,
  146274,
  167200,
  142220,
  180931,
  196923,
  148135,
  186563,
  135816,
  154406,
  122008,
  128939,
  146001,
  114875,
  176465,
  189800,
  133123,
  107449,
  115789,
  168926,
  123997,
  198939,
  171444,
  102486,
  164491,
  164045,
  127372,
  124978,
  122833,
  153465,
  140567,
  129591,
  109177,
  197164,
  136113,
  125994,
  135402,
  124090,
  172231,
  130339,
  110565,
  187245,
  191928,
  176069,
  149772,
  153168,
  178987,
  113352,
  195738,
  131822,
  134829,
  176952,
  100575,
  118985,
  166576,
  175356,
  167545,
  100751,
  114608,
  185178,
  174576,
  118633,
  142398,
  101266,
  120230,
  171678,
  100584,
  190685,
  115245,
  111685,
  185837,
  138477,
  154613,
  186572,
  158616,
  181085,
  130727,
  177514,
  136084,
  194728,
  118521,
  193169,
  109760,
  108685,
  147705,
  120442,
  106011,
  193351,
  100030,
  135931,
  116814,
  192838,
  128551,
  121230,
  141664,
  148647,
  174449,
  110118,
  189434,
  197327,
  148971,
  166975,
  187036,
  190669,
  133462,
  130729,
  145785,
  149505,
  175438,
  185562,
  194657,
  188684,
  137650,
  163354,
  190479,
  122767,
  192255,
  181819,
  159989,
  114600,
  129723,
  152022,
  183460,
  199082,
  137236,
  130976,
  153323,
  140695,
  172970,
  143957,
  185663,
  176097,
  128820,
  137954,
  104178,
  159775,
  196214,
  145248,
  114966,
  119486,
  152544,
  171645,
  103536,
  165555,
  102497,
  138107,
  142459,
  112708,
  150709,
  185880,
  177936,
  170682,
  123562,
  155766,
  179295,
  145132,
  133292,
  104849,
  105316,
  106345,
  106598,
  199909,
  170174,
  126687,
  156055,
  135487,
  147116,
  130430,
  162870,
  119437,
  153476,
  177633,
  140501,
  119703,
  147424,
  193135,
  193966,
  134007,
  125835,
  120501,
  173941,
  171996,
  175366,
  180029,
  143170,
  109946,
  155003,
  197965,
  198299,
  157955,
  194762,
  147692,
  142391,
  131236,
  138680,
  130076,
  163302,
  134599,
  189465,
  168087,
  186629,
  108482,
  179237,
  189583,
  138790,
  158130,
  188536,
  128091,
  176777,
  141048,
  157336,
  123375,
  192572,
  166585,
  158050,
  170681,
  128051,
  124867,
  152365,
  141081,
  174684,
  141268,
  196212,
  160465,
  117365,
  182868,
  187951,
  187617,
  186470,
  153119,
  153102,
  131885,
  141787,
  113509,
  151364,
  106296,
  102735,
  115961,
  171451,
  124038,
  140887,
  137032,
  193045,
  188843,
  187032,
  133463,
  119804,
  163976,
  129648,
  118574,
  103629,
  130358,
  122659,
  181599,
  111057,
  194869,
  131143,
  168118,
  153468,
  133404,
  104850,
  157398,
  194125,
  146115,
  103997,
  162478,
  197959,
  128573,
  128912,
  131639,
  179681,
  170978,
  132585,
  168225)

/*ICU First Day Vitals*/
# Pulling first vitals, which were required by the PESI score.
# HADM_ID was used to find patients as a quick workaround.
select * from `mimiciii_derived.vitalsfirstday` 

where HADM_ID in
(139788,
182135,
172454,
165934,
144159,
110275,
100826,
164098,
129744,
182573,
199898,
154639,
142149,
114241,
107530,
130079,
128160,
198911,
195826,
152188,
167021,
138421,
158183,
196065,
106481,
103175,
167558,
161020,
185409,
109340,
188192,
181683,
142100,
178274,
113350,
138803,
119596,
127242,
102942,
110568,
134311,
175238,
199207,
125277,
178211,
151145,
131893,
179968,
109361,
100525,
124391,
125077,
151731,
196982,
197611,
123815,
174899,
191645,
169308,
172466,
125303,
169182,
169525,
144752,
124627,
172672,
163318,
157722,
103931,
173330,
182280,
131239,
144709,
125831,
142254,
181593,
187907,
143994,
183007,
122694,
118736,
194201,
113272,
168854,
190004,
115843,
100187,
109789,
139698,
146274,
167200,
142220,
180931,
196923,
148135,
186563,
135816,
154406,
122008,
128939,
146001,
114875,
176465,
189800,
133123,
107449,
115789,
168926,
123997,
198939,
171444,
102486,
164491,
164045,
127372,
124978,
122833,
153465,
140567,
129591,
109177,
197164,
136113,
125994,
135402,
124090,
172231,
130339,
110565,
187245,
191928,
176069,
149772,
153168,
178987,
113352,
195738,
131822,
134829,
176952,
100575,
118985,
166576,
175356,
167545,
100751,
114608,
185178,
174576,
118633,
142398,
101266,
120230,
171678,
100584,
190685,
115245,
111685,
185837,
138477,
154613,
186572,
158616,
181085,
130727,
177514,
136084,
194728,
118521,
193169,
109760,
108685,
147705,
120442,
106011,
193351,
100030,
135931,
116814,
192838,
128551,
121230,
141664,
148647,
174449,
110118,
189434,
197327,
148971,
166975,
187036,
190669,
133462,
130729,
145785,
149505,
175438,
185562,
194657,
188684,
137650,
163354,
190479,
122767,
192255,
181819,
159989,
114600,
129723,
152022,
183460,
199082,
137236,
130976,
153323,
140695,
172970,
143957,
185663,
176097,
128820,
137954,
104178,
159775,
196214,
145248,
114966,
119486,
152544,
171645,
103536,
165555,
102497,
138107,
142459,
112708,
150709,
185880,
177936,
170682,
123562,
155766,
179295,
145132,
133292,
104849,
105316,
106345,
106598,
199909,
170174,
126687,
156055,
135487,
147116,
130430,
162870,
119437,
153476,
177633,
140501,
119703,
147424,
193135,
193966,
134007,
125835,
120501,
173941,
171996,
175366,
180029,
143170,
109946,
155003,
197965,
198299,
157955,
194762,
147692,
142391,
131236,
138680,
130076,
163302,
134599,
189465,
168087,
186629,
108482,
179237,
189583,
138790,
158130,
188536,
128091,
176777,
141048,
157336,
123375,
192572,
166585,
158050,
170681,
128051,
124867,
152365,
141081,
174684,
141268,
196212,
160465,
117365,
182868,
187951,
187617,
186470,
153119,
153102,
131885,
141787,
113509,
151364,
106296,
102735,
115961,
171451,
124038,
140887,
137032,
193045,
188843,
187032,
133463,
119804,
163976,
129648,
118574,
103629,
130358,
122659,
181599,
111057,
194869,
131143,
168118,
153468,
133404,
104850,
157398,
194125,
146115,
103997,
162478,
197959,
128573,
128912,
131639,
179681,
170978,
132585,
168225)

/*Mechanical Ventilation Duration*/
# Pulling mechanical ventional duration data. While this was not used, it was intended to be an outcome datapoint.
# HADM_ID was used to find patients as a quick workaround.
select ICUSTAYS.HADM_ID, VentDuration.* from `mimiciii_derived.ventdurations` VentDuration

left join `mimiciii_clinical.icustays` ICUStays on
VentDuration.ICUSTAY_ID = ICUSTAYS.ICUSTAY_ID

where ICUSTAYS.HADM_ID in
(139788,
182135,
172454,
165934,
144159,
110275,
100826,
164098,
129744,
182573,
199898,
154639,
142149,
114241,
107530,
130079,
128160,
198911,
195826,
152188,
167021,
138421,
158183,
196065,
106481,
103175,
167558,
161020,
185409,
109340,
188192,
181683,
142100,
178274,
113350,
138803,
119596,
127242,
102942,
110568,
134311,
175238,
199207,
125277,
178211,
151145,
131893,
179968,
109361,
100525,
124391,
125077,
151731,
196982,
197611,
123815,
174899,
191645,
169308,
172466,
125303,
169182,
169525,
144752,
124627,
172672,
163318,
157722,
103931,
173330,
182280,
131239,
144709,
125831,
142254,
181593,
187907,
143994,
183007,
122694,
118736,
194201,
113272,
168854,
190004,
115843,
100187,
109789,
139698,
146274,
167200,
142220,
180931,
196923,
148135,
186563,
135816,
154406,
122008,
128939,
146001,
114875,
176465,
189800,
133123,
107449,
115789,
168926,
123997,
198939,
171444,
102486,
164491,
164045,
127372,
124978,
122833,
153465,
140567,
129591,
109177,
197164,
136113,
125994,
135402,
124090,
172231,
130339,
110565,
187245,
191928,
176069,
149772,
153168,
178987,
113352,
195738,
131822,
134829,
176952,
100575,
118985,
166576,
175356,
167545,
100751,
114608,
185178,
174576,
118633,
142398,
101266,
120230,
171678,
100584,
190685,
115245,
111685,
185837,
138477,
154613,
186572,
158616,
181085,
130727,
177514,
136084,
194728,
118521,
193169,
109760,
108685,
147705,
120442,
106011,
193351,
100030,
135931,
116814,
192838,
128551,
121230,
141664,
148647,
174449,
110118,
189434,
197327,
148971,
166975,
187036,
190669,
133462,
130729,
145785,
149505,
175438,
185562,
194657,
188684,
137650,
163354,
190479,
122767,
192255,
181819,
159989,
114600,
129723,
152022,
183460,
199082,
137236,
130976,
153323,
140695,
172970,
143957,
185663,
176097,
128820,
137954,
104178,
159775,
196214,
145248,
114966,
119486,
152544,
171645,
103536,
165555,
102497,
138107,
142459,
112708,
150709,
185880,
177936,
170682,
123562,
155766,
179295,
145132,
133292,
104849,
105316,
106345,
106598,
199909,
170174,
126687,
156055,
135487,
147116,
130430,
162870,
119437,
153476,
177633,
140501,
119703,
147424,
193135,
193966,
134007,
125835,
120501,
173941,
171996,
175366,
180029,
143170,
109946,
155003,
197965,
198299,
157955,
194762,
147692,
142391,
131236,
138680,
130076,
163302,
134599,
189465,
168087,
186629,
108482,
179237,
189583,
138790,
158130,
188536,
128091,
176777,
141048,
157336,
123375,
192572,
166585,
158050,
170681,
128051,
124867,
152365,
141081,
174684,
141268,
196212,
160465,
117365,
182868,
187951,
187617,
186470,
153119,
153102,
131885,
141787,
113509,
151364,
106296,
102735,
115961,
171451,
124038,
140887,
137032,
193045,
188843,
187032,
133463,
119804,
163976,
129648,
118574,
103629,
130358,
122659,
181599,
111057,
194869,
131143,
168118,
153468,
133404,
104850,
157398,
194125,
146115,
103997,
162478,
197959,
128573,
128912,
131639,
179681,
170978,
132585,
168225)


/*Elixhauser*/
# Elixhauser data was pulled to identify patients with/without cancer, chronic lung disease, etc. as required by the PESI score.
select * from `mimiciii_derived.elixhauser_quan` 

where HADM_ID in
(139788,
182135,
172454,
165934,
144159,
110275,
100826,
164098,
129744,
182573,
199898,
154639,
142149,
114241,
107530,
130079,
128160,
198911,
195826,
152188,
167021,
138421,
158183,
196065,
106481,
103175,
167558,
161020,
185409,
109340,
188192,
181683,
142100,
178274,
113350,
138803,
119596,
127242,
102942,
110568,
134311,
175238,
199207,
125277,
178211,
151145,
131893,
179968,
109361,
100525,
124391,
125077,
151731,
196982,
197611,
123815,
174899,
191645,
169308,
172466,
125303,
169182,
169525,
144752,
124627,
172672,
163318,
157722,
103931,
173330,
182280,
131239,
144709,
125831,
142254,
181593,
187907,
143994,
183007,
122694,
118736,
194201,
113272,
168854,
190004,
115843,
100187,
109789,
139698,
146274,
167200,
142220,
180931,
196923,
148135,
186563,
135816,
154406,
122008,
128939,
146001,
114875,
176465,
189800,
133123,
107449,
115789,
168926,
123997,
198939,
171444,
102486,
164491,
164045,
127372,
124978,
122833,
153465,
140567,
129591,
109177,
197164,
136113,
125994,
135402,
124090,
172231,
130339,
110565,
187245,
191928,
176069,
149772,
153168,
178987,
113352,
195738,
131822,
134829,
176952,
100575,
118985,
166576,
175356,
167545,
100751,
114608,
185178,
174576,
118633,
142398,
101266,
120230,
171678,
100584,
190685,
115245,
111685,
185837,
138477,
154613,
186572,
158616,
181085,
130727,
177514,
136084,
194728,
118521,
193169,
109760,
108685,
147705,
120442,
106011,
193351,
100030,
135931,
116814,
192838,
128551,
121230,
141664,
148647,
174449,
110118,
189434,
197327,
148971,
166975,
187036,
190669,
133462,
130729,
145785,
149505,
175438,
185562,
194657,
188684,
137650,
163354,
190479,
122767,
192255,
181819,
159989,
114600,
129723,
152022,
183460,
199082,
137236,
130976,
153323,
140695,
172970,
143957,
185663,
176097,
128820,
137954,
104178,
159775,
196214,
145248,
114966,
119486,
152544,
171645,
103536,
165555,
102497,
138107,
142459,
112708,
150709,
185880,
177936,
170682,
123562,
155766,
179295,
145132,
133292,
104849,
105316,
106345,
106598,
199909,
170174,
126687,
156055,
135487,
147116,
130430,
162870,
119437,
153476,
177633,
140501,
119703,
147424,
193135,
193966,
134007,
125835,
120501,
173941,
171996,
175366,
180029,
143170,
109946,
155003,
197965,
198299,
157955,
194762,
147692,
142391,
131236,
138680,
130076,
163302,
134599,
189465,
168087,
186629,
108482,
179237,
189583,
138790,
158130,
188536,
128091,
176777,
141048,
157336,
123375,
192572,
166585,
158050,
170681,
128051,
124867,
152365,
141081,
174684,
141268,
196212,
160465,
117365,
182868,
187951,
187617,
186470,
153119,
153102,
131885,
141787,
113509,
151364,
106296,
102735,
115961,
171451,
124038,
140887,
137032,
193045,
188843,
187032,
133463,
119804,
163976,
129648,
118574,
103629,
130358,
122659,
181599,
111057,
194869,
131143,
168118,
153468,
133404,
104850,
157398,
194125,
146115,
103997,
162478,
197959,
128573,
128912,
131639,
179681,
170978,
132585,
168225)
